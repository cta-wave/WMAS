<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Web Platform Tests</title>
    <style>
      #console {
        font-family: monospace;
      }
    </style>
    <script src="lib/wave-service.js"></script>
  </head>
  <body>
    <div id="console"></div>
    <script>
      var screenConsole = document.getElementById("console");
      var log = function() {
        var text = "";
        for (var i = 0; i < arguments.length; i++) {
          text += arguments[i] + " ";
        }
        text = text.replace(/ /gm, "&nbsp;");
        text = text.replace(/\n/gm, "<br/>");
        screenConsole.innerHTML += "<br/>" + text;
      };

      window.onerror = function(error) {
        log(error);
      };

      var HOSTNAME = location.hostname;
      var PORT = location.port;
      var PROTOCOL = location.protocol.replace(/:/, "");
      var QUERY = decodeURIComponent(location.search.replace(/\?/, ""));
      var match = QUERY.match(/token=([^&]+)/);
      var TOKEN = match ? match[1] : null;
      QUERY += /[\?&]path=/.test(location.search) ? "" : "&resume=1";
      match = QUERY.match(/data=([^&]+)/);

      var parsedQuery = {};

      for (var part of QUERY.split("&")) {
        var key = part.split("=")[0];
        var value = part.split("=")[1];
        parsedQuery[key] = value;
      }

      var resultData;
      if (parsedQuery["result"]) {
        resultData = JSON.parse(decodeURIComponent(parsedQuery["result"]));
      }

      createResult(TOKEN, resultData, function() {
        readNextTest(TOKEN, function(url) {
          location.href = url;
        });
      });

      function createResult(token, result, onSuccess, onError) {
        sendRequest(
          "POST",
          "/nodejs/api/results/" + token,
          { "Content-Type": "application/json" },
          JSON.stringify(result),
          function() {
            onSuccess();
          },
          function(statusText, response) {
            onError(statusText, response);
          }
        );
      }

      function readNextTest(token, onSuccess, onError) {
        sendRequest(
          "GET",
          "/nodejs/api/tests/" + token + "/next",
          null,
          null,
          function(response) {
            var jsonObject = JSON.parse(response);
            onSuccess(jsonObject.next_test);
          },
          onError
        );
      }

      function sendRequest(method, uri, headers, data, onSuccess, onError) {
        var xhr = new XMLHttpRequest();
        xhr.addEventListener("load", function() {
          onSuccess(xhr.response);
        });
        xhr.addEventListener("error", function() {
          if (onError) onError();
        });
        xhr.open(method, WaveService.uriPrefix + uri, true);
        for (var header in headers) {
          xhr.setRequestHeader(header, headers[header]);
        }
        xhr.send(data);
      }
    </script>
  </body>
</html>
