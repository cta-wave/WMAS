<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Session Results - Web Platform Test</title>
    <link rel="stylesheet" href="css/bulma-0.7.4/bulma.min.css" />
    <link rel="stylesheet" href="css/fontawesome-5.7.2.min.css" />
    <link rel="stylesheet" href="css/result.css" />
    <script src="lib/jszip.min.js"></script>
    <script src="lib/utils.js"></script>
    <script src="lib/wave-service.js"></script>
    <script src="lib/ui.js"></script>
  </head>
  <body>
    <script>
      let token = null;
      window.onload = () => {
        const query = utils.parseQuery(location.search);
        token = query.token;
        if (token) {
          resultUi.render();
          resultUi.refreshData();
        } else {
          location.href = "/overview.html" + location.search;
        }
        WaveService.addRecentSession(token);
      };
      const resultUi = {
        state: {
          details: null,
          results: null,
          referenceSessions: [],
          addLabelVisible: false
        },
        refreshData: toUpdate => {
          switch (toUpdate) {
            case "complete":
              resultUi.refreshSessionStatus(() => {
                resultUi.refreshSessionResults(() => {
                  resultUi.renderApiResults();
                });
              });
              break;
            case "status":
              resultUi.refreshSessionStatus(() => {
                resultUi.renderControls();
                resultUi.renderSessionDetails();
              });
              break;
            case "":
            case null:
            case undefined:
              resultUi.refreshSessionConfiguration(() => {
                resultUi.refreshSessionStatus(() => {
                  resultUi.refreshReferenceSessions(() =>
                    resultUi.renderReferenceSessions()
                  );
                  resultUi.renderControls();
                  resultUi.renderSessionDetails();
                  resultUi.refreshSessionResults(() => {
                    resultUi.renderApiResults();
                  });
                });
              });
              break;
          }
        },
        refreshSessionConfiguration(callback = () => {}) {
          WaveService.readSession(token, configuration => {
            resultUi.state.configuration = configuration;
            callback(configuration);
          });
        },
        refreshSessionStatus(callback = () => {}) {
          WaveService.readSessionStatus(token, status => {
            resultUi.state.status = status;
            if (status.status !== "completed" && status.status !== "aborted")
              resultUi.connectWebSocket();
            callback(status);
          });
        },
        refreshReferenceSessions(callback = () => {}) {
          const { configuration } = resultUi.state;
          if (!configuration) return;
          const { referenceTokens } = configuration;
          if (!referenceTokens) return;
          WaveService.readMultipleSessions(referenceTokens, configuration => {
            resultUi.state.referenceSessions = configuration;
            resultUi.renderReferenceSessions();
            callback(configuration);
          });
        },
        refreshSessionResults(callback = () => {}) {
          WaveService.readResultsCompact(token, results => {
            const { status } = resultUi.state;
            Object.keys(status.testFilesCount).forEach(api =>
              !results[api] ? (results[api] = {}) : null
            );
            for (let api in results) {
              let { pass, fail, timeout, not_run } = results[api];
              let complete = 0;
              if (pass) complete += pass;
              if (fail) complete += fail;
              if (timeout) complete += timeout;
              if (not_run) complete += not_run;
              results[api].complete = complete;
              const { testFilesCount, testFilesCompleted } = status;
              if (!testFilesCount[api]) testFilesCount[api] = 0;
              if (!testFilesCompleted[api]) testFilesCompleted[api] = 0;
              results[api].isDone =
                testFilesCount[api] === testFilesCompleted[api];
              results[api].testFilesCount = testFilesCount[api];
              results[api].testFilesCompleted = testFilesCompleted[api];
            }
            resultUi.state.results = results;
            callback(results);
          });
        },
        connectWebSocket() {
          if (!WaveService.socket) {
            WaveService.connect(token);
            WaveService.onMessage(message => {
              resultUi.refreshData(message.data);
            });
          }
        },
        openResultsOverview() {
          location.href = "/overview.html";
        },
        stopSession() {
          WaveService.stopSession(token, resultUi.refreshData);
        },
        deleteSession() {
          WaveService.deleteSession(token, () =>
            resultUi.openResultsOverview()
          );
        },
        showDeleteModal() {
          const modal = UI.getElement("delete-modal");
          const className = modal.getAttribute("class");
          modal.setAttribute("class", className + " is-active");
        },
        hideDeleteModal() {
          const modal = UI.getElement("delete-modal");
          let className = modal.getAttribute("class");
          className = className.replace(" is-active", "");
          modal.setAttribute("class", className);
        },
        downloadApiResultJson(api) {
          const { results } = resultUi.state;
          if (!results[api].isDone) return;
          WaveService.downloadApiResult(token, api);
        },
        openHtmlReport(api) {
          const { results } = resultUi.state;
          if (!results[api].isDone) return;
          WaveService.readReportUri(token, api, function(uri) {
            window.open(uri, "_blank");
          });
        },
        downloadFinishedApiJsons() {
          WaveService.downloadAllApiResults(token);
        },
        downloadHtmlZip() {
          WaveService.downloadResultsOverview(token);
        },
        addLabel() {
          const label = UI.getElement("session-label-input").value;
          if (!label) return;
          const { configuration } = resultUi.state;
          configuration.labels.push(label);
          WaveService.updateSessionLabels(token, configuration.labels);
          resultUi.renderSessionDetails();
          UI.getElement("session-label-input").focus();
        },
        removeLabel(index) {
          if (!index) return;
          const { configuration } = resultUi.state;
          configuration.labels.splice(index, 1);
          WaveService.updateSessionLabels(token, configuration.labels);
          resultUi.renderSessionDetails();
        },
        showAddLabel() {
          resultUi.state.addLabelVisible = true;
          resultUi.renderSessionDetails();
          UI.getElement("session-label-input").focus();
        },
        hideAddLabel() {
          resultUi.state.addLabelVisible = false;
          resultUi.renderSessionDetails();
        },
        render() {
          const resultView = UI.createElement({
            className: "content",
            style: "margin-bottom: 40px;",
            children: [
              {
                className: "header",
                children: [
                  {
                    children: [
                      {
                        element: "img",
                        src: "res/wavelogo_2016.jpg",
                        className: "site-logo"
                      }
                    ]
                  },
                  {
                    className: "button is-dark is-outlined",
                    onclick: resultUi.openResultsOverview,
                    children: [
                      {
                        element: "span",
                        className: "icon",
                        children: [
                          {
                            element: "i",
                            className: "fas fa-arrow-left"
                          }
                        ]
                      },
                      {
                        text: "Results Overview",
                        element: "span"
                      }
                    ]
                  }
                ]
              },
              {
                id: "header",
                children: [
                  { className: "title", text: "Result" },
                  { id: "controls" }
                ]
              },
              { id: "session-details" },
              { id: "api-results" },
              { id: "timeout-files" },
              { id: "export" }
            ]
          });
          const root = UI.getRoot();
          root.innerHTML = "";
          root.appendChild(resultView);
          resultUi.renderControls();
          resultUi.renderSessionDetails();
          resultUi.renderApiResults();
          resultUi.renderExportView();
        },
        renderControls() {
          const { state } = resultUi;
          if (!state.status) return;
          const { status, is_public } = state.status;
          const controlsView = UI.createElement();
          if (
            status &&
            status !== "aborted" &&
            status !== "completed" &&
            status !== "pending"
          ) {
            const pauseResumeButton = UI.createElement({
              id: "pause-resume-button",
              className: "button is-dark is-outlined",
              style: "margin-right: 20px",
              onclick: function() {
                if (status === "running") {
                  WaveService.pauseSession(token, resultUi.refreshData);
                } else {
                  WaveService.startSession(token, resultUi.refreshData);
                }
              },
              children: [
                {
                  element: "span",
                  className: "icon",
                  children: [
                    {
                      element: "i",
                      className:
                        status === "running" ? "fas fa-pause" : "fas fa-play"
                    }
                  ]
                },
                {
                  text: status === "running" ? "Pause" : "Resume",
                  element: "span"
                }
              ]
            });
            controlsView.appendChild(pauseResumeButton);
          }

          if (status && status !== "aborted" && status !== "completed") {
            const stopButton = UI.createElement({
              id: "stop-button",
              className: "button is-dark is-outlined",
              onclick: resultUi.stopSession,
              children: [
                {
                  element: "span",
                  className: "icon",
                  children: [
                    {
                      element: "i",
                      className: "fas fa-square"
                    }
                  ]
                },
                {
                  text: "Stop",
                  element: "span"
                }
              ]
            });
            controlsView.appendChild(stopButton);
          }
          if (!is_public) {
            const deleteButton = UI.createElement({
              id: "delete-button",
              className: "button is-dark is-outlined",
              style: "margin-left: 20px",
              onclick: resultUi.showDeleteModal,
              children: [
                {
                  element: "span",
                  className: "icon",
                  children: [
                    {
                      element: "i",
                      className: "fas fa-trash-alt"
                    }
                  ]
                },
                {
                  text: "Delete",
                  element: "span"
                }
              ]
            });
            controlsView.appendChild(deleteButton);
          }

          const deleteModal = UI.createElement({
            id: "delete-modal",
            className: "modal",
            children: [
              {
                className: "modal-background",
                onclick: resultUi.hideDeleteModal
              },
              {
                className: "modal-card",
                children: [
                  {
                    className: "modal-card-head",
                    children: [
                      {
                        element: "p",
                        className: "modal-card-title",
                        text: "Delete Session"
                      }
                    ]
                  },
                  {
                    className: "modal-card-body",
                    children: [
                      {
                        element: "p",
                        text: "Are you sure you want to delete this session?"
                      },
                      { element: "p", text: "This action cannot be undone." }
                    ]
                  },
                  {
                    className: "modal-card-foot",
                    children: [
                      {
                        className: "button is-danger",
                        text: "Delete Session",
                        onclick: resultUi.deleteSession
                      },
                      {
                        className: "button",
                        text: "Cancel",
                        onclick: resultUi.hideDeleteModal
                      }
                    ]
                  }
                ]
              }
            ]
          });
          controlsView.appendChild(deleteModal);

          const controls = UI.getElement("controls");
          controls.innerHTML = "";
          controls.appendChild(controlsView);
        },
        renderSessionDetails() {
          const { state } = resultUi;
          const { configuration, status } = state;
          if (!configuration || !status) return;
          const sessionDetailsView = UI.createElement({
            style: "margin-bottom: 20px"
          });

          const heading = UI.createElement({
            text: "Session details",
            className: "title is-4"
          });
          sessionDetailsView.appendChild(heading);

          const getTagStyle = status => {
            switch (status) {
              case "completed":
                return "is-success";
              case "running":
                return "is-info";
              case "aborted":
                return "is-danger";
              case "paused":
                return "is-warning";
              case "pending":
                return "is-primary";
            }
          };
          if (status.dateFinished) {
            if (state.durationInterval) clearInterval(state.durationInterval);
          } else if (status.dateStarted) {
            if (!state.durationInterval)
              state.durationInterval = setInterval(() => {
                UI.getElement("duration").innerHTML = utils.millisToTimeString(
                  Date.now() - parseInt(status.dateStarted)
                );
              }, 1000);
          }

          const { addLabelVisible } = state;
          const { testFilesCount } = status;
          const detailsTable = UI.createElement({
            element: "table",
            children: {
              element: "tbody",
              children: [
                {
                  element: "tr",
                  children: [
                    { element: "td", text: "Token:", style: "width: 175px;" },
                    {
                      element: "td",
                      text: token,
                      className: "is-family-monospace"
                    }
                  ]
                },
                {
                  element: "tr",
                  children: [
                    { element: "td", text: "User Agent:" },
                    { element: "td", text: configuration.userAgent || "" }
                  ]
                },
                {
                  element: "tr",
                  children: [
                    { element: "td", text: "Test Path:" },
                    {
                      element: "td",
                      text: configuration.tests.include
                        .reduce((text, test) => text + test + ", ", "")
                        .slice(0, -2)
                    }
                  ]
                },
                { id: "reference-sessions", element: "tr" },
                {
                  element: "tr",
                  children: [
                    { element: "td", text: "Total Test Files:" },
                    {
                      element: "td",
                      text: Object.keys(testFilesCount).reduce(
                        (sum, api) => (sum += testFilesCount[api]),
                        0
                      )
                    }
                  ]
                },
                {
                  element: "tr",
                  children: [
                    { element: "td", text: "Status:" },
                    {
                      element: "td",
                      children: [
                        {
                          className: `tag ${getTagStyle(status.status)}`,
                          text: status.status
                        }
                      ]
                    }
                  ]
                },
                {
                  element: "tr",
                  children: [
                    { element: "td", text: "Test Timeout:" },
                    {
                      element: "td",
                      text: Object.keys(configuration.timeouts)
                        .reduce((text, timeout) => text + timeout + ", ", "")
                        .slice(0, -2)
                    }
                  ]
                },
                status.dateStarted
                  ? {
                      element: "tr",
                      children: [
                        { element: "td", text: "Started:" },
                        {
                          element: "td",
                          text: new Date(status.dateStarted).toLocaleString()
                        }
                      ]
                    }
                  : null,
                status.dateFinished
                  ? {
                      element: "tr",
                      children: [
                        { element: "td", text: "Finished:" },
                        {
                          element: "td",
                          text: new Date(status.dateFinished).toLocaleString()
                        }
                      ]
                    }
                  : null,
                status.dateStarted
                  ? {
                      element: "tr",
                      children: [
                        { element: "td", text: "Duration:" },
                        {
                          element: "td",
                          id: "duration",
                          text: utils.millisToTimeString(
                            status.dateFinished
                              ? parseInt(status.dateFinished) -
                                  parseInt(status.dateStarted)
                              : Date.now() - parseInt(status.dateStarted)
                          )
                        }
                      ]
                    }
                  : null,
                {
                  element: "tr",
                  children: [
                    {
                      element: "td",
                      text: "Labels:"
                    },
                    {
                      element: "td",
                      children: [
                        {
                          className: "field is-grouped is-grouped-multiline",
                          children: configuration.labels
                            .map((label, index) => ({
                              className: "control",
                              children: {
                                className: "tags has-addons",
                                children: [
                                  {
                                    element: "a",
                                    className: "tag is-info",
                                    text: label
                                  },
                                  {
                                    element: "a",
                                    className: "tag is-delete",
                                    onClick: () => resultUi.removeLabel(index)
                                  }
                                ]
                              }
                            }))
                            .concat(
                              addLabelVisible
                                ? [
                                    {
                                      className:
                                        "control field is-grouped is-grouped-multiline",
                                      children: [
                                        {
                                          element: "input",
                                          className: "input is-small control",
                                          style: "width: 10rem",
                                          id: "session-label-input",
                                          type: "text",
                                          onKeyUp: event =>
                                            event.keyCode === 13
                                              ? resultUi.addLabel()
                                              : null
                                        },
                                        {
                                          className:
                                            "button is-dark is-outlined is-small is-rounded control",
                                          text: "save",
                                          onClick: resultUi.addLabel
                                        },
                                        {
                                          className:
                                            "button is-dark is-outlined is-small is-rounded control",
                                          text: "cancel",
                                          onClick: resultUi.hideAddLabel
                                        }
                                      ]
                                    }
                                  ]
                                : [
                                    {
                                      className: "button is-rounded is-small",
                                      text: "Add",
                                      onClick: resultUi.showAddLabel
                                    }
                                  ]
                            )
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          });
          sessionDetailsView.appendChild(detailsTable);

          const sessionDetails = UI.getElement("session-details");
          sessionDetails.innerHTML = "";
          sessionDetails.appendChild(sessionDetailsView);
          resultUi.renderReferenceSessions();
        },
        renderReferenceSessions() {
          const { referenceSessions } = resultUi.state;
          if (!referenceSessions || referenceSessions.length === 0) return;
          const referenceSessionsList = UI.createElement({ element: "td" });
          const getBrowserIcon = browser => {
            switch (browser.toLowerCase()) {
              case "firefox":
                return "fab fa-firefox";
              case "edge":
                return "fab fa-edge";
              case "chrome":
              case "chromium":
                return "fab fa-chrome";
              case "safari":
              case "webkit":
                return "fab fa-safari";
            }
          };
          referenceSessions.forEach(session => {
            const { token, browser } = session;
            const referenceSessionItem = UI.createElement({
              style: "margin-right: 10px",
              className: "button is-dark is-small is-rounded is-outlined",
              onClick: () => WaveService.openSession(token),
              children: [
                {
                  element: "span",
                  className: "icon",
                  children: {
                    element: "i",
                    className: getBrowserIcon(browser.name)
                  }
                },
                {
                  element: "span",
                  className: "is-family-monospace",
                  text: token.split("-").shift()
                }
              ]
            });
            referenceSessionsList.appendChild(referenceSessionItem);
          });
          const referenceSessionsTarget = UI.getElement("reference-sessions");
          referenceSessionsTarget.innerHTML = "";
          referenceSessionsTarget.appendChild(
            UI.createElement({ element: "td", text: "Reference Sessions:" })
          );
          referenceSessionsTarget.appendChild(referenceSessionsList);
        },
        renderApiResults() {
          const { results, status } = resultUi.state;

          const apiResultsView = UI.createElement({
            style: "margin-bottom: 20px"
          });

          const heading = UI.createElement({
            text: "API Results",
            className: "title is-4"
          });
          apiResultsView.appendChild(heading);

          if (!results) {
            const loadingIndicator = UI.createElement({
              className: "level",
              children: {
                element: "span",
                className: "level-item icon",
                children: [
                  {
                    element: "i",
                    className: "fas fa-spinner fa-pulse"
                  },
                  {
                    style: "margin-left: 0.4em;",
                    text: "Loading results ..."
                  }
                ]
              }
            });
            apiResultsView.appendChild(loadingIndicator);

            const apiResults = UI.getElement("api-results");
            apiResults.innerHTML = "";
            apiResults.appendChild(apiResultsView);
            return;
          }

          const width = status.status === "running" ? "130px" : "auto";
          const header = UI.createElement({
            element: "thead",
            children: [
              {
                element: "tr",
                children: [
                  { element: "th", text: "API" },
                  { element: "th", text: "Pass", style: `width: ${width}` },
                  { element: "th", text: "Fail", style: `width: ${width}` },
                  { element: "th", text: "Timeout", style: `width: ${width}` },
                  { element: "th", text: "Not Run", style: `width: ${width}` },
                  {
                    element: "th",
                    text: "Test Files Run",
                    style: `width: ${width}`
                  },
                  { element: "th", text: "Export" }
                ]
              }
            ]
          });

          const apis = Object.keys(results).sort((apiA, apiB) =>
            apiA.toLowerCase() > apiB.toLowerCase() ? 1 : -1
          );

          const rows = apis.map(api => {
            const {
              complete = 0,
              pass = 0,
              fail = 0,
              timeout = 0,
              timeoutfiles = [],
              not_run: notRun = 0,
              isDone = false,
              testFilesCount,
              testFilesCompleted = 0
            } = results[api];
            return UI.createElement({
              element: "tr",
              // style: `background-image: linear-gradient(to right, hsl(0, 0%, 86%) ${utils.percent(
              //   testFilesCompleted,
              //   testFilesCount
              // )}%, white ${utils.percent(
              //   testFilesCompleted,
              //   testFilesCount
              // )}%); background-attachment: fixed;`,
              children: [
                { element: "td", text: api },
                {
                  element: "td",
                  style: "color: hsl(141, 71%, 38%)",
                  text: `${pass} (${utils.percent(pass, complete)}%)`
                },
                {
                  element: "td",
                  className: "has-text-danger",
                  text: `${fail} (${utils.percent(fail, complete)}%)`
                },
                {
                  element: "td",
                  style: "color: hsl(48, 100%, 40%)",
                  text: `${timeout} (${utils.percent(timeout, complete)}%)`
                },
                {
                  element: "td",
                  className: "has-text-info",
                  text: `${notRun} (${utils.percent(notRun, complete)}%)`
                },
                {
                  element: "td",
                  text: `${testFilesCompleted}/${testFilesCount} (${utils.percent(
                    testFilesCompleted,
                    testFilesCount
                  )}%)`
                },
                {
                  element: "td",
                  children: [
                    {
                      className: "button is-dark is-outlined is-small",
                      disabled: !isDone,
                      onclick: () => resultUi.downloadApiResultJson(api),
                      text: "json",
                      title: `Download results of ${api} API as JSON file.`
                    },
                    {
                      className: "button is-dark is-outlined is-small",
                      disabled: !isDone,
                      onclick: () => resultUi.openHtmlReport(api),
                      text: "report",
                      title: `Show results of ${api} API in WPT Report format.`
                    }
                  ]
                }
              ]
            });
          });

          const { pass, fail, timeout, not_run, complete } = apis.reduce(
            (sum, api) => {
              Object.keys(sum).forEach(
                key => (sum[key] += results[api][key] ? results[api][key] : 0)
              );
              return sum;
            },
            { complete: 0, pass: 0, fail: 0, timeout: 0, not_run: 0 }
          );
          const testFilesCount = Object.keys(results).reduce(
            (sum, api) => (sum += results[api].testFilesCount),
            0
          );
          const testFilesCompleted = Object.keys(results).reduce(
            (sum, api) => (sum += results[api].testFilesCompleted || 0),
            0
          );

          const footer = UI.createElement({
            element: "tfoot",
            // style: `background-image: linear-gradient(to right, hsl(0, 0%, 86%) ${utils.percent(
            //   testFilesCompleted,
            //   testFilesCount
            // )}%, white ${utils.percent(
            //   testFilesCompleted,
            //   testFilesCount
            // )}%); background-attachment: fixed;`,
            children: [
              {
                element: "tr",
                children: [
                  { element: "th", text: "Total" },
                  {
                    element: "th",
                    style: "color: hsl(141, 71%, 38%)",
                    text: `${pass} (${utils.percent(pass, complete)}%)`
                  },
                  {
                    element: "th",
                    className: "has-text-danger",
                    text: `${fail} (${utils.percent(fail, complete)}%)`
                  },
                  {
                    element: "th",
                    style: "color: hsl(48, 100%, 40%)",
                    text: `${timeout} (${utils.percent(timeout, complete)}%)`
                  },
                  {
                    element: "th",
                    className: "has-text-info",
                    text: `${not_run} (${utils.percent(not_run, complete)}%)`
                  },
                  {
                    element: "th",
                    text: `${testFilesCompleted}/${testFilesCount} (${utils.percent(
                      testFilesCompleted,
                      testFilesCount
                    )}%)`
                  },
                  { element: "th" }
                ]
              }
            ]
          });

          const resultsTable = UI.createElement({
            element: "table",
            className: "table",
            id: "results-table",
            style: "border-radius: 3px; border: 2px solid hsl(0, 0%, 86%);",
            children: [header, { element: "tbody", children: rows }, footer]
          });
          apiResultsView.appendChild(resultsTable);

          const apiResults = UI.getElement("api-results");
          apiResults.innerHTML = "";
          apiResults.appendChild(apiResultsView);
        },
        renderExportView() {
          const exportView = UI.createElement({
            children: [
              { className: "title is-4", text: "Export" },
              {
                element: "table",
                children: {
                  element: "tbody",
                  children: [
                    {
                      element: "tr",
                      children: [
                        {
                          element: "td",
                          className: "title is-6",
                          text: "Finished APIs JSON Files"
                        },
                        {
                          element: "td",
                          className: "article",
                          text:
                            "Download JSON files of this sessions finished APIs as zip file."
                        },
                        {
                          element: "td",
                          children: {
                            className:
                              "button is-dark is-outlined is-small is-fullwidth",
                            onclick: resultUi.downloadFinishedApiJsons,
                            children: [
                              {
                                element: "span",
                                className: "icon",
                                children: {
                                  element: "i",
                                  className: "fas fa-file-archive"
                                }
                              },
                              { element: "span", text: "Download Zip" }
                            ]
                          }
                        }
                      ]
                    },
                    {
                      element: "tr",
                      children: [
                        {
                          element: "td",
                          className: "title is-6",
                          text: "Session result HTML"
                        },
                        {
                          element: "td",
                          className: "article",
                          text:
                            "Download this sessions result as standalone HTML page, similar to this page."
                        },
                        {
                          element: "td",
                          children: {
                            className:
                              "button is-dark is-outlined is-small is-fullwidth",
                            onClick: resultUi.downloadHtmlZip,
                            children: [
                              {
                                element: "span",
                                className: "icon",
                                children: {
                                  element: "i",
                                  className: "fas fa-code"
                                }
                              },
                              { element: "span", text: "Download HTML" }
                            ]
                          }
                        }
                      ]
                    }
                  ]
                }
              }
            ]
          });

          const exportElement = UI.getElement("export");
          exportElement.innerHTML = "";
          exportElement.appendChild(exportView);
        }
      };
    </script>
  </body>
</html>
