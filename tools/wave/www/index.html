<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Web Media API Snapshot 2018 (WMAS 2018) Test Suite</title>
    <link rel="stylesheet" href="css/bulma-0.7.5/bulma.min.css" />
    <link rel="stylesheet" href="css/fontawesome.min.css" />
    <link rel="stylesheet" href="css/main.css" />
    <script src="lib/keycodes.js"></script>
    <script src="lib/wave-service.js"></script>
    <script src="lib/qrcode.js"></script>
  </head>
  <body>
    <section class="section">
      <div class="container">
        <img
          class="site-logo"
          src="res/wavelogo_2016.jpg"
          alt="WAVE (Web Application Video Ecosystem) Project Logo"
        />

        <h1 class="title is-spaced">
          Web Media API Snapshot 2018 (WMAS 2018) Test Suite
        </h1>
        <p class="subtitle">
          <a href="https://github.com/cta-wave/WMAS">GitHub</a> -
          <a href="https://github.com/cta-wave/WMAS/issues">Issues</a> -
          <a href="https://www.w3.org/2018/12/webmediaapi.html">WMAS2018</a>
        </p>
      </div>

      <div class="container" style="margin-top: 2em;">
        <h2 class="title is-5">
          New test session
        </h2>
        <div class="columns is-vcentered" style="margin-top: 20px">
          <div class="column is-narrow">
            <div
              id="qr-code"
              style="width: 256px; height: 256px; padding: 5px; border: 1px gray solid; border-radius: 3px;"
            ></div>
          </div>
          <div class="column">
            <table style="margin-bottom: 1.5em">
              <tr>
                <td class="has-text-weight-bold" style="padding-right: 1rem">Token:</td>
                <td id="session-token" class="is-family-monospace"></td>
              </tr>
              <tr>
                <td class="has-text-weight-bold" style="padding-right: 1rem">Expires:</td>
                <td id="expiary-date"></td>
              </tr>
              <tr>
                <td></td>
                <td>
                  <p class="is-size-7">(Session start revokes expiration.)</p>
                </td>
              </tr>
            </table>

            <p style="width: 32rem; margin-bottom: 1rem;">
              Configure a new session on a second device by scanning the
              QR-Code, or click the button:
            </p>
            <div
              class="button"
              style="margin-bottom: 1rem;"
              id="configure-button"
            >
              Configure Session
            </div>
            <p style="width: 32rem;">
              The tests will start running in this window, as soon as the
              session is started from the configuration view.
            </p>
          </div>
        </div>
      </div>

      <div class="container" style="margin-top: 2em;">
        <h2 class="title is-5">
          Resume running session
        </h2>
        <article
          id="unknown_token_error"
          style="max-width: 30em; display: none"
          class="message is-danger"
        >
          <div class="message-body">
            Unknown token
          </div>
        </article>
        <form id="resume" class="field">
          <div class="field">
            <label class="label">Token (first 8 characters or more)</label>
            <div class="control">
              <input
                id="resume_token"
                class="input is-family-monospace tabbable"
                type="text"
                style="max-width: 30em"
              />
            </div>
          </div>
          <div class="button-group">
            <button
              id="submit-form"
              class="button is-success tabbable"
              type="submit"
              data-uid="100"
              autofocus
            >
              Resume
            </button>
          </div>
        </form>
      </div>
    </section>
  </body>

  <script>
    var selectedTabbable = -1;

    function removeClass(element, className) {
      var elementClass = element.className;
      var index = elementClass.indexOf(className);
      if (index !== -1) {
        element.className = elementClass.replace(className, "");
      }
    }

    function addClass(element, className) {
      element.className += " " + className;
    }

    function skipFocus(steps) {
      var tabbables = document.getElementsByClassName("tabbable");
      if (selectedTabbable === -1) {
        selectedTabbable = 0;
      } else {
        removeClass(tabbables[selectedTabbable], "focused");
        selectedTabbable += steps;
      }

      if (selectedTabbable >= tabbables.length) {
        selectedTabbable = 0;
      }

      if (selectedTabbable < 0) {
        selectedTabbable = tabbables.length - 1;
      }

      tabbables[selectedTabbable].focus();
      addClass(tabbables[selectedTabbable], "focused");
    }

    function focusNext() {
      skipFocus(1);
    }

    function focusPrevious() {
      skipFocus(-1);
    }

    // Resume
    var resumeToken = "";
    var cookies = document.cookie.split(";");
    for (var i; i < cookies.length; i++) {
      var cookie = cookies[i];
      if (cookie.split("=")[0].replace(/ /g, "") === "resume_token") {
        resumeToken = cookie.split("=")[1];
        break;
      }
    }
    if (!resumeToken) resumeToken = "";
    var tokenText = document.getElementById("resume_token");
    tokenText.value = resumeToken;
    var unknownTokenError = document.getElementById("unknown_token_error");
    document
      .getElementById("resume")
      .addEventListener("submit", function(event) {
        event.preventDefault();
        unknownTokenError.style.display = "none";
        var fragment = tokenText.value;
        if (!fragment) return;

        WaveService.findToken(
          fragment,
          function(token) {
            location.href = "/next.html?token=" + token;
          },
          function() {
            unknownTokenError.style.display = "block";
          }
        );
      });

    document.onkeydown = function(event) {
      event = event || window.event;
      var charCode =
        typeof event.which === "number" ? event.which : event.keyCode;

      if (ACTION_KEYS.indexOf(charCode) !== -1) {
        event.preventDefault();
        var tabbables = document.getElementsByClassName("tabbable");
        var element = tabbables[selectedTabbable];
        if (element.type === "checkbox") {
          element.checked = !element.checked;
        } else {
          element.click();
        }
      }

      if (PREV_KEYS.indexOf(charCode) !== -1) {
        focusPrevious();
      }

      if (NEXT_KEYS.indexOf(charCode) !== -1) {
        focusNext();
      }
    };

    var lifeTime = 30 * 60 * 1000; // 30min
    WaveService.createSession(
      { expirationDate: new Date().getTime() + lifeTime },
      function(token) {
        var sessionTokenElement = document.getElementById("session-token");
        sessionTokenElement.innerText = token;

        WaveService.readSession(token, function(config) {
          var expiaryDateElement = document.getElementById("expiary-date");
          expiaryDateElement.innerText = new Date(
            config.expirationDate
          ).toLocaleString();
        });

        var configurationUrl =
          "http://" +
          location.host +
          "/configuration.html?token=" +
          token +
          "&resume=" +
          resumeToken;
        new QRCode(document.getElementById("qr-code"), configurationUrl);
        document.getElementById("configure-button").onclick = function() {
          window.open(configurationUrl, "_blank");
        };

        WaveService.connect(token);
        WaveService.onMessage(function(message) {
          if (message.type === "resume") {
            var resumeToken = message.data;
            location.href = "/next.html?token=" + resumeToken;
          }

          if (message.type !== "status") return;
          if (message.data === "pending") return;
          location.href = "/next.html?token=" + token;
        });
      }
    );
  </script>
</html>
